<html>
<h1>
	Render {{ .hash }}
</h1>

<div id="content">EMPTY</div>
<script>
    var overrides = {};
    async function go() {
        t = await (await fetch("/h/{{ .hash }}")).text();
        try {
            const obj = JSON.parse(t);
            if (obj.target) {
                console.log("target", obj.target);
                overrides = obj.overrides;
                console.log("overrides", overrides);
                // Send overrides to sw.
                t = await (await fetch("/h/" + obj.target)).text();
                document.open();
                document.write(t);
                document.close();
                return;
            } else {
                // Continue
            }
        } catch (e) {
            // Continue.
        }
        // https://stackoverflow.com/questions/483745/replace-html-page-with-contents-retrieved-via-ajax
        document.open();
        document.write(t);
        document.close();
    }
    navigator.serviceWorker.addEventListener('message', async event => {
        const hash = "bafkreiag6clwepuduyo6nhyyqcj6rbpnnj6e3i7xc7uezxq7nc7nban44e";
        const url = event.data.url;
        const upload = false;
        var res = {};
        if (url.startsWith("http://localhost:8080/")
            || url.startsWith("https://multiverse-312721.nw.r.appspot.com/")
            ) {
            // Default.
            res = {url: url};
        } else if (event.data.method != "GET") {
            res = {};
        } else if (url.startsWith("https://mv/")) {
            const hash = url.replace("https://mv/", "");
            console.log("hash: ", hash);
            res = {url: "/h/" + hash};
        } else {
            const hash = overrides[url];
            if (hash != undefined) {
                console.log("url mapped to hash: ", hash);
                res = {url: "/h/" + hash};
            } else {
                if (upload) {
                    /*
                    console.log('caching ' + url);
                    const response = await fetch(url, {redirect: "follow"});
                    // console.log("download response: ", response);
                    const data = new FormData();
                    data.append("file", await response.blob(), "file");
                    const uploadResponse = await fetch("/upload", { method: "POST", body: data });
                    // console.log("upload response: ", uploadResponse);
                    const hash = await uploadResponse.text();
                    overrides[url] = hash;
                    res = {url: "/h/" + hash};
                    */
                    res = {url: url, upload: true};
                } else {
                    res = {};
                }
            }
        }
        console.log(overrides);
        // console.log("sending ", res);
        event.data.s.postMessage(res);
    });
    navigator.serviceWorker.register('/render_sw.js').then((registration) => {
        console.log('registration succeeded')
        registration.update().then((_) => {
            go();
        });
    }).catch((error) => {
        console.log("registration failed: ", error);
    });

</script>

</html>
